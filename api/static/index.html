<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpoofyVibe ‚Äî Email Security Dashboard</title>
    <meta name="description" content="Real-time email security posture analysis dashboard">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111627;
            --bg-card: #161b2e;
            --bg-card-hover: #1c2340;
            --bg-input: #1a2035;
            --border: #252d45;
            --border-glow: #3b82f6;
            --text-primary: #e8eaf0;
            --text-secondary: #8892b0;
            --text-muted: #5a6380;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-pink: #ec4899;
            --gradient-hero: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-card: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(139,92,246,0.05) 100%);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 30px rgba(59,130,246,0.15);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        /* --- Background animation --- */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(59,130,246,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139,92,246,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(236,72,153,0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        /* --- Header --- */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(10,14,26,0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
        }
        .header-inner {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
            height: 64px;
        }
        .logo {
            display: flex; align-items: center; gap: 10px;
            font-weight: 800; font-size: 1.25rem;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo-icon { font-size: 1.5rem; -webkit-text-fill-color: initial; }
        .nav { display: flex; gap: 4px; }
        .nav-btn {
            padding: 8px 18px; border: none; border-radius: var(--radius-sm);
            background: transparent; color: var(--text-secondary);
            font-family: inherit; font-weight: 500; font-size: 0.875rem;
            cursor: pointer; transition: all 0.2s;
        }
        .nav-btn:hover { color: var(--text-primary); background: var(--bg-card); }
        .nav-btn.active {
            color: var(--accent-blue); background: rgba(59,130,246,0.12);
        }
        /* --- Layout --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Scan Tab --- */
        .scan-hero {
            text-align: center; padding: 3rem 0 2rem;
        }
        .scan-hero h1 {
            font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .scan-hero p { color: var(--text-secondary); font-size: 1.1rem; }
        .scan-form {
            max-width: 720px; margin: 2rem auto;
            display: flex; gap: 12px;
        }
        .scan-input {
            flex: 1; padding: 14px 18px;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text-primary);
            font-family: inherit; font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .scan-input:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
        }
        .scan-input::placeholder { color: var(--text-muted); }
        .scan-btn {
            padding: 14px 32px; border: none; border-radius: var(--radius);
            background: var(--gradient-hero); color: white;
            font-family: inherit; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: transform 0.15s, box-shadow 0.2s;
            white-space: nowrap;
        }
        .scan-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-glow); }
        .scan-btn:active { transform: translateY(0); }
        .scan-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .scan-options {
            max-width: 720px; margin: 0 auto 2rem;
            display: flex; gap: 24px; justify-content: center;
        }
        .option-label {
            display: flex; align-items: center; gap: 8px;
            color: var(--text-secondary); font-size: 0.875rem; cursor: pointer;
        }
        .option-label input[type="checkbox"] {
            appearance: none; width: 18px; height: 18px;
            border: 2px solid var(--border); border-radius: 4px;
            background: var(--bg-input); cursor: pointer;
            transition: all 0.2s; position: relative;
        }
        .option-label input[type="checkbox"]:checked {
            background: var(--accent-blue); border-color: var(--accent-blue);
        }
        .option-label input[type="checkbox"]:checked::after {
            content: '‚úì'; position: absolute; top: -1px; left: 2px;
            color: white; font-size: 12px; font-weight: 700;
        }
        /* --- Status --- */
        .scan-status {
            text-align: center; padding: 1rem 0;
            color: var(--text-secondary); font-size: 0.9rem;
        }
        .scan-status .spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid var(--border); border-top-color: var(--accent-blue);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Results Cards --- */
        .results-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 1.5rem; }
        .result-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 24px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .result-card:hover {
            border-color: rgba(59,130,246,0.3); box-shadow: var(--shadow-glow);
        }
        .result-header {
            display: flex; align-items: center; gap: 16px; margin-bottom: 20px;
        }
        .grade-badge {
            width: 56px; height: 56px; border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.25rem; color: white; flex-shrink: 0;
        }
        .grade-a-plus, .grade-a { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .grade-b-plus, .grade-b, .grade-b-minus { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .grade-c-plus, .grade-c, .grade-c-minus { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .grade-d-plus, .grade-d, .grade-d-minus { background: linear-gradient(135deg, #f97316, #ea580c); }
        .grade-f { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .result-meta h3 { font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
        .result-meta .score-line {
            color: var(--text-secondary); font-size: 0.875rem;
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .badge {
            padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .badge-spoofable { background: rgba(239,68,68,0.15); color: var(--accent-red); border: 1px solid rgba(239,68,68,0.3); }
        .badge-safe { background: rgba(34,197,94,0.15); color: var(--accent-green); border: 1px solid rgba(34,197,94,0.3); }
        .badge-maybe { background: rgba(234,179,8,0.15); color: var(--accent-yellow); border: 1px solid rgba(234,179,8,0.3); }

        /* Score bars */
        .score-bars { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 16px; }
        .bar-item { font-size: 0.8rem; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 3px; color: var(--text-secondary); }
        .bar-track { height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }
        .bar-fill.green { background: var(--accent-green); }
        .bar-fill.blue { background: var(--accent-blue); }
        .bar-fill.yellow { background: var(--accent-yellow); }
        .bar-fill.orange { background: var(--accent-orange); }
        .bar-fill.red { background: var(--accent-red); }

        /* Expandable details */
        .details-toggle {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-secondary);
            padding: 8px 16px; font-family: inherit; font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s; margin-right: 8px; margin-bottom: 8px;
        }
        .details-toggle:hover { color: var(--text-primary); border-color: var(--accent-blue); }
        .details-panel {
            display: none; background: var(--bg-input); border-radius: var(--radius-sm);
            padding: 16px; margin-top: 12px; font-size: 0.85rem;
        }
        .details-panel.open { display: block; animation: fadeIn 0.2s ease; }
        .detail-row { display: flex; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .detail-key { width: 200px; color: var(--text-secondary); font-weight: 500; flex-shrink: 0; }
        .detail-val { color: var(--text-primary); word-break: break-all; }
        .detail-val.mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.8rem; }

        /* Remediation */
        .remed-card {
            background: var(--bg-input); border-radius: var(--radius-sm);
            padding: 12px 16px; margin-bottom: 8px;
            border-left: 3px solid var(--border);
        }
        .remed-card.remed-critical { border-left-color: var(--accent-red); }
        .remed-card.remed-high { border-left-color: var(--accent-orange); }
        .remed-card.remed-medium { border-left-color: var(--accent-yellow); }
        .remed-card.remed-low { border-left-color: var(--accent-blue); }
        .remed-card.remed-info { border-left-color: var(--accent-cyan); }
        .remed-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .remed-priority {
            padding: 1px 8px; border-radius: 4px; font-size: 0.7rem;
            font-weight: 700; text-transform: uppercase;
        }
        .pri-critical { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        .pri-high { background: rgba(249,115,22,0.2); color: var(--accent-orange); }
        .pri-medium { background: rgba(234,179,8,0.2); color: var(--accent-yellow); }
        .pri-low { background: rgba(59,130,246,0.2); color: var(--accent-blue); }
        .pri-info { background: rgba(6,182,212,0.2); color: var(--accent-cyan); }
        .remed-cat { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .remed-title { font-weight: 600; font-size: 0.9rem; }
        .remed-desc { color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; }

        /* --- History Tab --- */
        .history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 12px; }
        .history-header h2 { font-size: 1.5rem; font-weight: 700; }
        .search-input {
            padding: 10px 16px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-primary);
            font-family: inherit; font-size: 0.875rem; width: 300px;
        }
        .search-input:focus { outline: none; border-color: var(--accent-blue); }
        .history-table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            background: var(--bg-card); border-radius: var(--radius-lg);
            overflow: hidden; border: 1px solid var(--border);
        }
        .history-table th {
            background: var(--bg-secondary); color: var(--text-secondary);
            font-weight: 600; font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.05em; padding: 12px 16px; text-align: left;
        }
        .history-table td {
            padding: 12px 16px; border-top: 1px solid var(--border);
            font-size: 0.875rem;
        }
        .history-table tr:hover td { background: var(--bg-card-hover); }
        .history-table .grade-cell {
            font-weight: 700; width: 48px;
        }
        .history-table .domain-cell { font-weight: 500; }
        .history-table .score-cell { font-variant-numeric: tabular-nums; }
        .pagination {
            display: flex; justify-content: center; gap: 8px; margin-top: 1.5rem;
        }
        .page-btn {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-card); color: var(--text-secondary);
            font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }
        .page-btn:hover { border-color: var(--accent-blue); color: var(--text-primary); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Stats Cards --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px; text-align: center;
        }
        .stat-val {
            font-size: 2rem; font-weight: 800;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }

        /* --- Subdomain Tab --- */
        .sub-form { max-width: 520px; margin: 2rem auto; display: flex; gap: 12px; }
        .sub-results { margin-top: 1.5rem; }
        .sub-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 8px;
        }
        .sub-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 10px 16px;
            font-size: 0.875rem; display: flex; align-items: center; gap: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .sub-item:hover { border-color: var(--accent-blue); transform: translateX(4px); }
        .sub-item .sub-icon { color: var(--accent-cyan); font-size: 0.7rem; }

        /* --- Domain Detail Modal --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px); z-index: 1000;
            justify-content: center; align-items: flex-start; padding: 40px 20px;
            overflow-y: auto;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: var(--radius-lg); width: 100%; max-width: 800px;
            box-shadow: var(--shadow-lg); position: relative;
        }
        .modal-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 1px solid var(--border);
        }
        .modal-head h3 { font-size: 1.15rem; font-weight: 600; }
        .modal-close {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.5rem; cursor: pointer; line-height: 1;
        }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }

        /* --- Trend Chart (CSS-only) --- */
        .trend-chart  {
            display: flex; align-items: flex-end; gap: 6px;
            height: 80px; padding: 8px 0;
        }
        .trend-bar {
            flex: 1; min-width: 20px; border-radius: 4px 4px 0 0;
            background: var(--accent-blue); transition: height 0.5s ease;
            position: relative; cursor: pointer;
        }
        .trend-bar:hover::after {
            content: attr(data-label);
            position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%);
            background: var(--bg-primary); border: 1px solid var(--border);
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;
            white-space: nowrap; color: var(--text-primary);
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .scan-form { flex-direction: column; }
            .scan-hero h1 { font-size: 1.75rem; }
            .score-bars { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .history-header { flex-direction: column; align-items: stretch; }
            .search-input { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Header -->
<header class="header">
    <div class="header-inner">
        <div class="logo">
            <span class="logo-icon">üõ°Ô∏è</span> SpoofyVibe
        </div>
        <nav class="nav">
            <button class="nav-btn active" onclick="showTab('scan')">Scan</button>
            <button class="nav-btn" onclick="showTab('history')">History</button>
            <button class="nav-btn" onclick="showTab('subdomains')">Subdomains</button>
        </nav>
    </div>
</header>

<!-- Main Content -->
<div class="container">

    <!-- ==================== SCAN TAB ==================== -->
    <div id="tab-scan" class="tab-content active">
        <div class="scan-hero">
            <h1>Email Security Audit</h1>
            <p>Analyze SPF, DMARC, DKIM, MTA-STS, MX, and BIMI in seconds</p>
        </div>

        <div class="scan-form">
            <input type="text" class="scan-input" id="scan-domains"
                   placeholder="Enter domains (comma-separated)  e.g. example.com, test.org"
                   onkeydown="if(event.key==='Enter')startScan()">
            <button class="scan-btn" id="scan-btn" onclick="startScan()">üîç Scan</button>
        </div>

        <div class="scan-options">
            <label class="option-label">
                <input type="checkbox" id="opt-dkim"> DKIM Enumeration
            </label>
            <label class="option-label">
                <input type="checkbox" id="opt-starttls" checked> STARTTLS Check
            </label>
        </div>

        <div class="scan-status" id="scan-status"></div>
        <div class="results-grid" id="results-grid"></div>
    </div>

    <!-- ==================== HISTORY TAB ==================== -->
    <div id="tab-history" class="tab-content">
        <div class="stats-grid" id="stats-grid"></div>

        <div class="history-header">
            <h2>Scan History</h2>
            <input type="text" class="search-input" id="history-search"
                   placeholder="üîç Filter by domain..."
                   oninput="debounce(loadHistory, 300)()">
        </div>

        <table class="history-table" id="history-table">
            <thead>
                <tr>
                    <th>Grade</th>
                    <th>Domain</th>
                    <th>Score</th>
                    <th>Status</th>
                    <th>Scanned</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>

    <!-- ==================== SUBDOMAINS TAB ==================== -->
    <div id="tab-subdomains" class="tab-content">
        <div class="scan-hero">
            <h1>Subdomain Discovery</h1>
            <p>Discover subdomains via Certificate Transparency logs</p>
        </div>

        <div class="sub-form">
            <input type="text" class="scan-input" id="sub-domain"
                   placeholder="Enter base domain  e.g. example.com"
                   onkeydown="if(event.key==='Enter')discoverSubdomains()">
            <button class="scan-btn" onclick="discoverSubdomains()">üîé Discover</button>
        </div>

        <div class="scan-status" id="sub-status"></div>
        <div class="sub-results" id="sub-results"></div>
    </div>
</div>

<!-- Domain Detail Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <div class="modal-head">
            <h3 id="modal-title">Domain Details</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
// ============================================================
//  SpoofyVibe Dashboard ‚Äî Client-side Logic
// ============================================================

const API = '';  // Same origin

// --- Tab Navigation ---
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.querySelector(`.nav-btn[onclick="showTab('${tab}')"]`).classList.add('active');
    if (tab === 'history') { loadStats(); loadHistory(); }
}

// --- Scan ---
async function startScan() {
    const input = document.getElementById('scan-domains').value.trim();
    if (!input) return;

    const domains = input.split(/[,\s\n]+/).map(d => d.trim()).filter(Boolean);
    const dkim = document.getElementById('opt-dkim').checked;
    const starttls = document.getElementById('opt-starttls').checked;
    const btn = document.getElementById('scan-btn');
    const status = document.getElementById('scan-status');
    const grid = document.getElementById('results-grid');

    btn.disabled = true;
    grid.innerHTML = '';
    status.innerHTML = `<span class="spinner"></span> Scanning ${domains.length} domain${domains.length > 1 ? 's' : ''}...`;

    try {
        const resp = await fetch(API + '/api/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domains, enable_dkim: dkim, check_starttls: starttls }),
        });
        const data = await resp.json();

        if (data.results && data.results.length > 0) {
            status.innerHTML = `‚úÖ Scanned ${data.results.length} domain${data.results.length > 1 ? 's' : ''} successfully`;
            data.results.forEach(r => grid.innerHTML += renderResultCard(r));
        } else {
            status.innerHTML = '‚ö†Ô∏è No results returned';
        }
        if (data.errors && data.errors.length > 0) {
            status.innerHTML += ` (${data.errors.length} error${data.errors.length > 1 ? 's' : ''})`;
        }
    } catch (e) {
        status.innerHTML = `‚ùå Error: ${e.message}`;
    }
    btn.disabled = false;
}

function renderResultCard(r) {
    const grade = r.SECURITY_GRADE || '?';
    const score = r.SECURITY_SCORE || 0;
    const domain = r.DOMAIN || 'unknown';
    const spoofable = r.SPOOFING_POSSIBLE;
    const breakdown = r.SCORE_BREAKDOWN || {};
    const recommendations = r.RECOMMENDATIONS || [];

    const gradeClass = 'grade-' + grade.toLowerCase().replace('+', '-plus').replace('-', '-minus');
    const spoofBadge = spoofable === true ? '<span class="badge badge-spoofable">Spoofable</span>'
        : spoofable === false ? '<span class="badge badge-safe">Not Spoofable</span>'
        : '<span class="badge badge-maybe">Maybe Spoofable</span>';

    const categories = [
        { key: 'spf', label: 'SPF', max: 20 },
        { key: 'dmarc', label: 'DMARC', max: 25 },
        { key: 'dkim', label: 'DKIM', max: 15 },
        { key: 'bimi', label: 'BIMI', max: 5 },
        { key: 'spoofability', label: 'Spoof Resistance', max: 15 },
        { key: 'mta_sts', label: 'MTA-STS', max: 10 },
        { key: 'mx', label: 'MX', max: 10 },
    ];

    let barsHTML = '';
    categories.forEach(c => {
        const s = (breakdown[c.key] || {}).score || 0;
        const pct = (s / c.max * 100).toFixed(0);
        const color = pct >= 80 ? 'green' : pct >= 60 ? 'blue' : pct >= 40 ? 'yellow' : pct > 0 ? 'orange' : 'red';
        barsHTML += `
            <div class="bar-item">
                <div class="bar-label"><span>${c.label}</span><span>${s}/${c.max}</span></div>
                <div class="bar-track"><div class="bar-fill ${color}" style="width:${pct}%"></div></div>
            </div>`;
    });

    // Detail sections
    const detailSections = [
        { id: 'spf-' + domain, label: 'SPF Details', content: renderSPFDetails(r) },
        { id: 'dmarc-' + domain, label: 'DMARC Details', content: renderDMARCDetails(r) },
        { id: 'dkim-' + domain, label: 'DKIM Details', content: renderDKIMDetails(r) },
        { id: 'mx-' + domain, label: 'MX Details', content: renderMXDetails(r) },
        { id: 'mtasts-' + domain, label: 'MTA-STS Details', content: renderMTASTSDetails(r) },
    ];

    let detailBtns = '', detailPanels = '';
    detailSections.forEach(s => {
        detailBtns += `<button class="details-toggle" onclick="toggleDetail('${s.id}')">${s.label}</button>`;
        detailPanels += `<div class="details-panel" id="panel-${s.id}">${s.content}</div>`;
    });

    // Remediation
    let remedHTML = '';
    if (recommendations.length > 0) {
        const topRecs = recommendations.slice(0, 5);
        remedHTML = '<div style="margin-top:16px">';
        remedHTML += `<h4 style="color:var(--text-secondary);margin-bottom:8px;font-size:0.85rem">
            üí° Remediation (${recommendations.length} items)</h4>`;
        topRecs.forEach(rec => {
            const pri = (rec.priority_label || 'info').toLowerCase();
            remedHTML += `
                <div class="remed-card remed-${pri}">
                    <div class="remed-header">
                        <span class="remed-priority pri-${pri}">${rec.priority_label || 'INFO'}</span>
                        <span class="remed-cat">${rec.category || ''}</span>
                    </div>
                    <div class="remed-title">${esc(rec.title || '')}</div>
                    <div class="remed-desc">${esc(rec.description || '')}</div>
                </div>`;
        });
        if (recommendations.length > 5) {
            remedHTML += `<p style="color:var(--text-muted);font-size:0.8rem;text-align:center;margin-top:8px">
                + ${recommendations.length - 5} more items</p>`;
        }
        remedHTML += '</div>';
    }

    return `
        <div class="result-card">
            <div class="result-header">
                <div class="grade-badge ${gradeClass}">${grade}</div>
                <div class="result-meta">
                    <h3>${esc(domain)}</h3>
                    <div class="score-line">
                        Score: ${score}/100 &nbsp;¬∑&nbsp; ${spoofBadge}
                    </div>
                </div>
            </div>
            <div class="score-bars">${barsHTML}</div>
            <div>${detailBtns}</div>
            ${detailPanels}
            ${remedHTML}
        </div>`;
}

function renderSPFDetails(r) {
    return detailRows([
        ['SPF Record', r.SPF, true],
        ['All Mechanism', r.SPF_MULTIPLE_ALLS],
        ['DNS Lookups', r.SPF_NUM_DNS_QUERIES],
        ['Too Many Lookups', r.SPF_TOO_MANY_DNS_QUERIES ? '‚ö†Ô∏è Yes' : '‚úÖ No'],
    ]);
}
function renderDMARCDetails(r) {
    return detailRows([
        ['DMARC Record', r.DMARC, true],
        ['Policy', r.DMARC_POLICY],
        ['Subdomain Policy', r.DMARC_SP],
        ['PCT', r.DMARC_PCT],
        ['ASPF', r.DMARC_ASPF],
        ['Aggregate Report (rua)', r.DMARC_AGGREGATE_REPORT, true],
    ]);
}
function renderDKIMDetails(r) {
    const selectors = r.DKIM_SELECTORS || [];
    if (selectors.length === 0) return '<p style="color:var(--text-muted)">No DKIM selectors found</p>';
    let html = '<div style="display:flex;flex-direction:column;gap:6px">';
    selectors.forEach(s => {
        const bits = s.key_bits || '?';
        const weak = bits !== '?' && bits < 2048;
        html += `<div style="display:flex;gap:12px;align-items:center">
            <span style="color:var(--accent-cyan);font-weight:600;min-width:120px">${esc(s.selector)}</span>
            <span style="color:${weak ? 'var(--accent-orange)' : 'var(--accent-green)'}">${bits}-bit</span>
            ${weak ? '<span class="badge badge-spoofable" style="font-size:0.65rem">WEAK</span>' : ''}
        </div>`;
    });
    html += '</div>';
    return html;
}
function renderMXDetails(r) {
    const records = r.MX_RECORDS || [];
    if (records.length === 0) return '<p style="color:var(--text-muted)">No MX records found</p>';
    let html = '';
    if (r.MX_PROVIDERS && r.MX_PROVIDERS.length > 0) {
        html += `<div style="margin-bottom:10px;color:var(--text-secondary)">Providers: <strong style="color:var(--text-primary)">${r.MX_PROVIDERS.join(', ')}</strong></div>`;
    }
    html += '<div style="display:flex;flex-direction:column;gap:4px">';
    records.forEach(mx => {
        const tls = mx.starttls === true ? 'üîí' : mx.starttls === false ? '‚ö†Ô∏è' : '‚ùì';
        html += `<div class="detail-row">
            <span class="detail-key">${tls} ${esc(mx.host || '')}</span>
            <span class="detail-val">${mx.ptr ? 'PTR: ' + esc(mx.ptr) : '<span style="color:var(--accent-orange)">No PTR</span>'}</span>
        </div>`;
    });
    html += '</div>';
    return html;
}
function renderMTASTSDetails(r) {
    return detailRows([
        ['MTA-STS TXT', r.MTA_STS_TXT, true],
        ['Policy Mode', r.MTA_STS_MODE],
        ['Max Age', r.MTA_STS_MAX_AGE],
        ['TLS-RPT Record', r.TLS_RPT_RECORD, true],
        ['TLS-RPT rua', r.TLS_RPT_RUA],
    ]);
}

function detailRows(pairs) {
    return pairs.map(([k, v, mono]) => `
        <div class="detail-row">
            <span class="detail-key">${k}</span>
            <span class="detail-val ${mono ? 'mono' : ''}">${v != null ? esc(String(v)) : '<span style="color:var(--text-muted)">Not found</span>'}</span>
        </div>`).join('');
}

function toggleDetail(id) {
    const panel = document.getElementById('panel-' + id);
    panel.classList.toggle('open');
}

// --- History ---
let historyPage = 0;
const PAGE_SIZE = 20;

async function loadHistory() {
    const search = document.getElementById('history-search').value.trim();
    try {
        const params = new URLSearchParams({ limit: PAGE_SIZE, offset: historyPage * PAGE_SIZE });
        if (search) params.set('domain', search);
        const resp = await fetch(API + '/api/history?' + params);
        const data = await resp.json();
        const scans = data.scans || [];

        const tbody = document.getElementById('history-body');
        if (scans.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px">
                No scan history yet. Run a scan to get started!</td></tr>`;
        } else {
            tbody.innerHTML = scans.map(s => {
                const gradeClass = 'grade-' + (s.grade || 'f').toLowerCase().replace('+', '-plus').replace('-', '-minus');
                const spoofBadge = s.spoofable === 1 ? '<span class="badge badge-spoofable">Spoofable</span>'
                    : s.spoofable === 0 ? '<span class="badge badge-safe">Safe</span>'
                    : '<span class="badge badge-maybe">Maybe</span>';
                const ts = new Date(s.timestamp).toLocaleString();
                return `<tr onclick="showScanDetail(${s.id})" style="cursor:pointer">
                    <td class="grade-cell"><span class="grade-badge ${gradeClass}" style="width:36px;height:36px;font-size:0.85rem">${s.grade}</span></td>
                    <td class="domain-cell">${esc(s.domain)}</td>
                    <td class="score-cell">${s.score}/100</td>
                    <td>${spoofBadge}</td>
                    <td style="color:var(--text-secondary);font-size:0.8rem">${ts}</td>
                    <td><button class="details-toggle" onclick="event.stopPropagation();viewDomainTrend('${esc(s.domain)}')">üìà Trend</button></td>
                </tr>`;
            }).join('');
        }

        // pagination
        const pag = document.getElementById('pagination');
        pag.innerHTML = `
            <button class="page-btn" onclick="historyPage=Math.max(0,historyPage-1);loadHistory()" ${historyPage === 0 ? 'disabled' : ''}>‚Üê Prev</button>
            <span style="padding:8px;color:var(--text-secondary)">Page ${historyPage + 1}</span>
            <button class="page-btn" onclick="historyPage++;loadHistory()" ${scans.length < PAGE_SIZE ? 'disabled' : ''}>Next ‚Üí</button>`;
    } catch (e) {
        console.error('Failed to load history:', e);
    }
}

async function loadStats() {
    try {
        const resp = await fetch(API + '/api/stats');
        const data = await resp.json();
        const s = data.stats || {};
        document.getElementById('stats-grid').innerHTML = `
            <div class="stat-card"><div class="stat-val">${s.total_scans || 0}</div><div class="stat-label">Total Scans</div></div>
            <div class="stat-card"><div class="stat-val">${s.unique_domains || 0}</div><div class="stat-label">Unique Domains</div></div>
            <div class="stat-card"><div class="stat-val">${s.avg_score || 0}</div><div class="stat-label">Avg Score</div></div>
            <div class="stat-card"><div class="stat-val">${s.spoofable_count || 0}</div><div class="stat-label">Spoofable</div></div>
            <div class="stat-card"><div class="stat-val">${s.safe_count || 0}</div><div class="stat-label">Secure</div></div>`;
    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

async function showScanDetail(scanId) {
    try {
        const resp = await fetch(API + '/api/history/detail/' + scanId);
        const data = await resp.json();
        if (data.scan && data.scan.result) {
            const r = data.scan.result;
            document.getElementById('modal-title').textContent = r.DOMAIN || 'Scan Detail';
            document.getElementById('modal-body').innerHTML = renderResultCard(r);
            document.getElementById('modal-overlay').classList.add('open');
        }
    } catch (e) {
        console.error('Failed to load scan detail:', e);
    }
}

async function viewDomainTrend(domain) {
    try {
        const resp = await fetch(API + '/api/history/' + domain);
        const data = await resp.json();
        const trend = data.trend || [];

        document.getElementById('modal-title').textContent = domain + ' ‚Äî Score Trend';
        let html = '';

        if (trend.length > 0) {
            html += '<div class="trend-chart">';
            trend.forEach(t => {
                const h = Math.max(t.score, 5);
                const color = t.score >= 80 ? 'var(--accent-green)' : t.score >= 60 ? 'var(--accent-blue)' :
                    t.score >= 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                const label = `${t.grade} (${t.score}) ‚Äî ${new Date(t.timestamp).toLocaleDateString()}`;
                html += `<div class="trend-bar" style="height:${h}%;background:${color}" data-label="${label}"></div>`;
            });
            html += '</div>';
            html += '<p style="text-align:center;color:var(--text-muted);font-size:0.75rem;margin-top:8px">Hover bars for details</p>';
        } else {
            html = '<p style="color:var(--text-muted);text-align:center;padding:20px">No trend data available yet</p>';
        }

        // Show latest scan details
        const scans = data.scans || [];
        if (scans.length > 0) {
            html += '<h4 style="margin-top:20px;margin-bottom:10px;color:var(--text-secondary)">Recent Scans</h4>';
            html += '<div style="display:flex;flex-direction:column;gap:6px">';
            scans.slice(0, 5).forEach(s => {
                const ts = new Date(s.timestamp).toLocaleString();
                html += `<div class="detail-row">
                    <span class="detail-key">${s.grade} (${s.score}/100)</span>
                    <span class="detail-val">${ts}</span>
                </div>`;
            });
            html += '</div>';
        }

        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-overlay').classList.add('open');
    } catch (e) {
        console.error('Failed to load trend:', e);
    }
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('open');
}

// --- Subdomains ---
async function discoverSubdomains() {
    const domain = document.getElementById('sub-domain').value.trim();
    if (!domain) return;

    const status = document.getElementById('sub-status');
    const results = document.getElementById('sub-results');
    status.innerHTML = '<span class="spinner"></span> Querying Certificate Transparency logs...';
    results.innerHTML = '';

    try {
        const resp = await fetch(API + '/api/subdomains/' + domain);
        const data = await resp.json();
        const subs = data.subdomains || [];

        status.innerHTML = `‚úÖ Found ${subs.length} subdomain${subs.length !== 1 ? 's' : ''} for ${esc(domain)}`;
        if (data.error) status.innerHTML += ` <span style="color:var(--accent-orange)">(${data.error})</span>`;

        results.innerHTML = `
            <div style="margin-bottom:12px;display:flex;gap:12px;align-items:center">
                <button class="scan-btn" style="font-size:0.85rem;padding:10px 20px"
                    onclick="scanSubdomains('${esc(domain)}')">üîç Scan All Subdomains</button>
                <span style="color:var(--text-muted);font-size:0.85rem">${subs.length} targets</span>
            </div>
            <div class="sub-list">
                ${subs.map(s => `
                    <div class="sub-item" onclick="scanSingleFromSub('${esc(s)}')">
                        <span class="sub-icon">‚óè</span> ${esc(s)}
                    </div>`).join('')}
            </div>`;
    } catch (e) {
        status.innerHTML = `‚ùå Error: ${e.message}`;
    }
}

function scanSingleFromSub(domain) {
    document.getElementById('scan-domains').value = domain;
    showTab('scan');
    startScan();
}

async function scanSubdomains(baseDomain) {
    const resp = await fetch(API + '/api/subdomains/' + baseDomain);
    const data = await resp.json();
    const subs = data.subdomains || [];
    document.getElementById('scan-domains').value = subs.join(', ');
    showTab('scan');
    startScan();
}

// --- Utilities ---
function esc(s) {
    if (s == null) return '';
    const d = document.createElement('div');
    d.textContent = String(s);
    return d.innerHTML;
}

function debounce(fn, ms) {
    let timer;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), ms);
    };
}

// Close modal on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>
